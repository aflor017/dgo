---
output:
  md_document:
    variant: markdown_github
---
[![Build Status](https://travis-ci.org/jamesdunham/dgo.svg?branch=master)](https://travis-ci.org/jamesdunham/dgo)

dgo is an R package for dynamic estimation of group-level opinion.

dgo implements Bayesian models for estimating subpopulation groups' average
conservatism (or other trait) from individuals' responses to dichotomous
questions. These models are "dynamic" both in the sense that groups are allowed
to evolve over time and in the sense that the model "borrows strength" from
other time periods, to a degree specified by the user.

[This
document](https://github.com/jamesdunham/dgo/blob/master/inst/dgirt_details.pdf)
describes the model in detail. It is a modified version of the hierarchical
group-level IRT model implemented by [Caughey and Warshaw
2015](http://pan.oxfordjournals.org/content/early/2015/02/04/pan.mpu021.full.pdf+html).

```{r, knitr-options, echo = FALSE}
# rmarkdown::render("README.Rmd")
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-",
  cache = FALSE)
```

## Prerequisites

Installation requires [RStan](http://mc-stan.org/interfaces/rstan.html) and its
prerequisites. If you don't have RStan, follow its "[Getting
Started](https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started)" guide
before continuing.

## Installation

dgo can be installed from [GitHub](https://github.com/jamesdunham/dgo) using
[devtools](https://github.com/hadley/devtools/):
```{r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("jamesdunham/dgo", dependencies = TRUE)
```

## Getting started

```{r}
library(dgo)
```

The minimal workflow from raw data to estimation is:

  1. shape input data using the `shape` function; and
  2. pass the result to the `dgirt` function to fit a DGIRT model.

### Set RStan options

These are RStan's recommended options on a local, multicore machine with excess
RAM:

```{r}
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

### Prepare inputs with `shape`

The `shape()` function returns data formatted for modeling with dgo. Its minimal
arguments give a table of individual-level survey response data, response
variable names, and the names of variables that define subpopulation groups.
These groups are typically defined by respondents' local geographic areas and
demographic characteristics.

There is also a required argument for specifying which variable in the data
represents time, because dgo models are dynamic.

Finally, `shape()` requires the names of survey identifier and survey weight
variables.

```{r}
dgirt_in <- shape(opinion,
                  item_names = c("abortion", "affirmative_action",
                    "stemcell_research", "gaymarriage_amendment",
                    "partialbirth_abortion"),
                  time_name = "year",
                  geo_name = "state",
                  group_names = "race3",
                  geo_filter = c("CA", "GA", "LA", "MA"),
                  survey_name = "source",
                  weight_name = "weight")
```

The result can be summarized in a few ways before model fitting, with
the `summary()`, `get_n()`, and `get_item_n()` functions.


### Fit a model with `dgirt`

`dgirt()` fits a model to data from `shape()`. `dgirt()` uses RStan for MCMC
sampling and has a `...` argument passed to `stan()`. 

```{r, warning = FALSE, cache = FALSE}
dgirt_out <- dgirt(dgirt_in, iter = 1500, chains = 4, cores = 4, seed = 42,
                   refresh = 0)
```

`dgirt()` returns a `dgirt_fit` object that inherits from the `stanfit` class.

### Work with `dgirt` results

Use `summary()` for a high-level summary of model results. 

```{r}
summary(dgirt_out)
```

To summarize posterior samples, use `summarize`. The default output gives
summary statistics for the `theta_bar` parameters, which represent the mean of
the latent outcome for the groups defined by time, local geographic area, and
the demographic characteristics specified in the earlier call to `shape`.

```{r}
head(summarize(dgirt_out))
```

Alternatively, `summarize` can apply arbitrary functions to posterior samples
for whatever parameter is given by its `pars` argument. Enclose function names
with quotes. For convenience, `"q_025"` and `"q_975"` give the 2.5th and 97.5th
posterior quantiles.

```{r}
summarize(dgirt_out, pars = "xi", funs = "var")
```

To access posterior samples in tabular form use `as.data.frame`. By default,
this returns post-warmup samples for the `theta_bar` parameters.  Use a `pars`
argument to access other parameters.

```{r}
head(as.data.frame(dgirt_out))
```

To poststratify the results use `poststratify`.

The following example uses the group population proportions bundled as `targets`
to reweight and aggregate estimates to strata defined by state-years.

```{r}
head(targets)
```

The `prop` variable in `targets` gives row-year population proportions. For
poststratification of `dgirt()` group estimates (i.e., theta-bars), we require
the yearly population proportion for each group. We can calculate these
proportions by summing over the row proportions in `targets` by group-year.

```{r}
targets <- aggregate(prop ~ year + state + race3, targets, sum)
# proportions should sum to one within years 
all(round(aggregate(prop ~ year, targets, sum)$prop, 1) == 1)
head(targets)
```

```{r}
poststratify(dgirt_out, targets, strata_names = c("state", "year"),
             aggregated_names = "race3")
```

To plot the results use `dgirt_plot`. This plots summaries of posterior samples
by time period. By default, it shows a 95% credible interval around posterior
medians for the `theta_bar` parameters, for each local geographic area.

```{r}
dgirt_plot(dgirt_out, y_min = NULL, y_max = NULL)
```

Output from `dgirt_plot` can be customized to some extent using objects from the
ggplot2 package.

`dgirt_plot` can also plot the `data.frame` output from `poststratify`, but this
requires that we identify the relevant variables in the `data.frame`.

Below, `poststratify` aggregates over the demographic grouping variable `race3`,
resulting in a `data.frame` of estimates by state-year. So, in the subsequent
call to `dgirt_plot`, we pass the names of the `state` and `year` variables. The
`group_names` argument is given as `NULL`, because no other grouping variables
remain.

```{r}
ps <- poststratify(dgirt_out, targets, strata_names = c("state", "year"),
  aggregated_names = "race3")
head(ps)
dgirt_plot(ps, group_names = NULL, time_name = "year", geo_name = "state")
```

## Troubleshooting

Please [report issues](https://github.com/jamesdunham/dgo/issues) that you
encounter.

OS X only: RStan creates temporary files during estimation in a location given
by `tempdir`, typically an arbitrary location in `/var/folders`. If a model runs
for days, these files can be cleaned up while still needed, which induces an
error. A good solution is to set a safer path for temporary files, using an
environment variable checked at session startup. As described in `?tempdir`, 

> The environment variables ‘TMPDIR’, ‘TMP’ and ‘TEMP’ are checked in turn and
> the first found which points to a writable directory is used: if none succeeds
> ‘/tmp’ is used. The path should not contain spaces.

For help setting environment variables, see the Stack Overflow question
[here](https://stackoverflow.com/questions/17107206/change-temporary-directory).
Confirm the new path before starting your model run by restarting R and checking
the output from `tempdir()`.

```{r, eval = FALSE}
# Problematic temporary directories on OS X look like this
tempdir()   
#> [1] "/var/folders/2p/_d3c95qd6ljg28j1f5l2jqxm0000gn/T//Rtmp38a10A"
```

## Contributing and citing

dgo is under development and we welcome
[suggestions](https://github.com/jamesdunham/dgo/issues).

The package citation is 

> Dunham, James, Devin Caughey, and Christopher Warshaw. 2017. dgo: Dynamic
> Estimation of Group-level Opinion. R package. https://jamesdunham.github.io/dgo/.
